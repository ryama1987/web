### 2021/11/11
AWS関連の作業については、コーポレート用のインスタンスを作成してサーバを立ち上げ、
apacheまでインストール完了。

### 2021/12/2
・apache（httpd）のvirtualhostの設定
・aws内に以下のディレクトリ作成
　L /var/www/html/corprate　　※コーポレートを想定
　L /var/www/html/staff　　　 ※スタッフを想定
・windowsのhostファイルに仮ドメイン追記
・コーポレートで使われているSSIの設定適用
・FTP（winSCP）でもファイルアップできるよう、chmodによる権限変更

### 2021/12/9
SSL設定まで完了。
※virtualhostにおいてポート443を設定し、SSLを有効にする設定。
また、httpでアクセスした際、httpsへリダイレクトするRewriteEngineの設定を含む。

### 2021/12/10～23
ユーザー問い合わせフォームの調査と検証

phpモジュールの有効化作業
php-mbstringのインストール
php-fpmによる再起動と設定反映
mysqlのインストールとユーザー設定
phpMyAdminのインストール
※以下の記事を参考に、エラーを解消しながら作業。

[phpモジュールの有効化作業の参考]
https://hacknote.jp/archives/57628/

[MySQLインストールの参考]
https://qiita.com/miriwo/items/eb09c065ee9bb7e8fe06

[phpMyAdminのインストール参考]
https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ec2-lamp-amazon-linux-2.html#install-phpmyadmin-lamp-server

###2021/12/24
◆ユーザー問い合わせフォームの表示およびDBへの登録までは確認。
テスト環境SFへの登録が上手く動かない状況。

※以下のエラー解消を検証中
```
Warning: Use of undefined constant SOAP_SINGLE_ELEMENT_ARRAYS - assumed 'SOAP_SINGLE_ELEMENT_ARRAYS' (this will throw an Error in a future version of PHP) in /var/www/html/data/soapclient/SforceBaseClient.php on line 114

Warning: Use of undefined constant SOAP_COMPRESSION_ACCEPT - assumed 'SOAP_COMPRESSION_ACCEPT' (this will throw an Error in a future version of PHP) in /var/www/html/data/soapclient/SforceBaseClient.php on line 115

Warning: Use of undefined constant SOAP_COMPRESSION_GZIP - assumed 'SOAP_COMPRESSION_GZIP' (this will throw an Error in a future version of PHP) in /var/www/html/data/soapclient/SforceBaseClient.php on line 115

Fatal error: Uncaught Error: Class 'SoapClient' not found in /var/www/html/data/soapclient/SforceBaseClient.php:64 Stack trace: #0 /var/www/html/data/soapclient/SforceBaseClient.php(133): SforceBaseClient->getSoapClient('/var/www/html/d...', Array) #1 /var/www/html/corporate/entry/user_inquiry/thanks.php(141): SforceBaseClient->createConnection('/var/www/html/d...') #2 {main} thrown in /var/www/html/data/soapclient/SforceBaseClient.php on line 64
```

### 2021/12/27
コーポレート内の問い合わせフォームを動くよう改修完了。

以下の動作確認済。

・テスト環境のDBへの登録
・テスト環境のSFへの登録
・自動返信メールの受信

≪メモ≫
（1） SFの登録でバグが出ていた理由は、SOAP通信するためのphpモジュールがなかったため、ということが分かった。
以下の記事を参考に対応。今回は《yum install php-soap》で解決。
https://polidog.jp/2014/01/13/phpsoap/

（2）自動返信メール送信でもエラー発生。
メール処理のJCMail.phpは、jsunet_dbのapi_settingというテーブルを読み込んでいることが分かった。
これがないとphpが動かない。現在は解決済。
/data/log/にエラーログが格納されるので、DB関連のエラーを解決する糸口になる。

### 2022/1/17
コーポレート内にあるほかのフォームも一旦移管して動くところまでは確認。
※リダイレクトかかっているものに関しては、.htaccessを作って対応予定。

### 2022/1/18～20、2022/2/10～2/15
スタッフのMTも移管して構築できるか現在確認中。
・データベースを移管してエラー潰してる状態。
・サイドナビなどのインクルードファイルが上手く読み込まれないので改修及び検証中。
・/search/や/entry/　以外の移管はとりあえず完了。

### 2022/2/16
スタッフで/entry/関連対応中。
ログインフォームが動かないことが分かったので、回避策を検討中。

※松本さんにも以下報告済。

・AWSにてジャスネットスタッフのサーバ移管を検証していたところ、
JCAuth.phpを使っているログインフォームが動かないことが分かった。
具体的には、JCAuth.phpにある、関数fetchSessionId()が動かなかった。
↓
・調べてみたところ、php7.2からmcryptという暗号化関連のものが削除されている。
https://www.php.net/manual/ja/function.mcrypt-get-block-size.php
↓
・代替案として、open_sslを使う記事を見かける。
https://agency-star.co.jp/column/php--with-mcrypt
↓
・AWSの方のJCAuth.phpにopen_sslを使った関数を追加して動くか検証する。

### 2022/2/17
さらに調べていたところ、各サイトにある/api/session_set_cookie.php　もmcryptという暗号化を使っている。
ジャスネットのログイン処理の設計上、上記の箇所も変更しないとログイン処理系は動かない可能性が出てきた。

### 2022/03/08
ビジ文の文字化けは修正済。また、ビジ文の既存のリダイレクト設定もhtacessファイルに置き換え完了。

【メモ】
文字化けの原因は、ビジ文のhtmlがShift-JISだったため。
linuxで文字コード変換コマンドnkf(Network Kanji Filter)をインストールすれば一括変換可能。

（参考）
https://www.ritolab.com/entry/106
https://marbles.hatenablog.com/entry/2018/09/08/220254
https://it-ojisan.tokyo/grepsed/

### 2022/03/15、2022/04/06
/edu/直下にあるファイルに関して、以下の修正対応を実施し、AWSへ移管完了。

・文字コードの変換
　→Shift-JIS => utf-8への変換
・各ファイルにおけるhtmlのmetaタグの修正
　→charsetがShift-JIS になっているので、utf-8へ置換
・ファイルの拡張子の一括変換
　→.asp, .shtml, .htmlとなっている拡張子を.phpに変換
・リダイレクト設定
・エラーが出ているphpファイルの改修
※一括変換は、Linuxの方がいろいろ手法がそろっていたので、wsl（Windows Subsystem for Linux）を導入して対応。

```sh
for fname in *html;
do mv $fname ${fname%.html}.php;
done

nkf -w --overwrite xxxxxxxxxxxxx.asp

find ./ -type f -print0 | xargs -0 nkf -g
find ./ -type -name "*.asp" -print0 | xargs -0 nkf -g
```

### 2022/04/07

/edu/seminar/以下をAWSへ移管完了。

主な作業としては、以下。
・文字コードの変換
　→Shift-JIS => utf-8への変換
・各ファイルにおけるhtmlのmetaタグの修正
　→charsetがShift-JIS になっているので、utf-8へ置換
・ファイルの拡張子の一括変換
　→.asp, .shtml, .htmlとなっている拡張子を.phpに変換
・リダイレクト設定
・エラーが出ているphpファイルの改修
/edu/entry/に関しては、
web.configでリダイレクト設定されているものはアップしない方向で仕分け中。

2022/04/08
バグ改修を実施。

voice_o01.php　などの中でインクルードされているファイルで
「同じファイル名で拡張子だけが違う」という状態だっため、置換した際に自身をインクルードするようになってしまっていた。
※voice_o01.php　の中で、voice_o01.phpを読む状態になってしまっていた。

以下の形でインクルードされるファイル名を変えてバグを改修。対象ファイル62個。

```
for fname in *.php;
do grep -i $fname $fname | xargs sed -i.bak s/$fname/${fname%.php}_include.php/g $fname;
done
/edu/term/以下も移管用にファイルを置換。変換対象ファイル約800個。

#! shtml→php　拡張子変換
for fname in `find ./ -name "*.shtml" -printf "%P\n"`;
do rename 's/.shtml/.php/' $fname;
done
#! htm→php　拡張子変換
for fname in `find ./ -name "*.htm" -printf "%P\n"`;
do rename 's/.htm/.php/' $fname;
done
【残タスク】
phpファイルのインクルード部分の指定先の調整が必要。grepで一括置換までは完了している。（ローカルのcnvディレクトリ参照）
```

【参考にした記事】
https://webbibouroku.com/Blog/Article/linux-rename
https://sekisuiseien.com/computer/11100/
https://uguisu.skr.jp/Windows/find_xargs2.html
https://e-seventh.com/linux-xargs-basic-usage/
https://www.rough-and-cheap.jp/linux/find_result_formatting/

### 2022/04/11
ファイルの移管とリダイレクト（.htaccess）の設定完了。

【参考】
・日本語URLのリダイレクト設定情報。
基本、日本語そのままでOKのようだった。
→https://www.websuccess.jp/blog/archives/3676/
→https://alaki.co.jp/blog/?p=2394

【設定例】
```
RewriteEngine on
RewriteBase /japan

RewriteRule ^a/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=あ [R=301,L]
RewriteRule ^e/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=え [R=301,L]
RewriteRule ^ha/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=は [R=301,L]
RewriteRule ^he/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=へ [R=301,L]
RewriteRule ^hi/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=ひ [R=301,L]
RewriteRule ^ho/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=ほ [R=301,L]
RewriteRule ^hu/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=ふ [R=301,L]
RewriteRule ^i/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=い [R=301,L]
RewriteRule ^ka/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=か [R=301,L]
RewriteRule ^ke/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=け [R=301,L]
RewriteRule ^ki/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=き [R=301,L]
RewriteRule ^ko/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=こ [R=301,L]
RewriteRule ^ku/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=く [R=301,L]
RewriteRule ^ma/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=ま [R=301,L]
RewriteRule ^mi/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=み [R=301,L]
RewriteRule ^mo/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=も [R=301,L]
RewriteRule ^na/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=な [R=301,L]
RewriteRule ^ne/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=ね [R=301,L]
RewriteRule ^no/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=の [R=301,L]
RewriteRule ^o/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=お [R=301,L]
RewriteRule ^ra/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=ら [R=301,L]
RewriteRule ^re/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=れ [R=301,L]
RewriteRule ^ri/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=り [R=301,L]
RewriteRule ^ro/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=ろ [R=301,L]
RewriteRule ^ru/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=る [R=301,L]
RewriteRule ^sa/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=さ [R=301,L]
RewriteRule ^se/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=せ [R=301,L]
RewriteRule ^si/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=し [R=301,L]
RewriteRule ^so/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=そ [R=301,L]
RewriteRule ^su/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=す [R=301,L]
RewriteRule ^ta/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=た [R=301,L]
RewriteRule ^te/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=て [R=301,L]
RewriteRule ^ti/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=ち [R=301,L]
RewriteRule ^to/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=と [R=301,L]
RewriteRule ^u/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=う [R=301,L]
RewriteRule ^wa/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=わ [R=301,L]
RewriteRule ^yo/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=よ [R=301,L]
RewriteRule ^yu/(.*)$ https://career.jusnet.co.jp/dictionary/search.php?kana=ゆ [R=301,L]

RewriteCond %{REQUEST_URI} (^/term/japan/)
RewriteRule ^$ https://career.jusnet.co.jp/dictionary/ [R=301,L]
```

### 2022/04/12、2022/04/14、2022/04/15
/entry/以下の調整中。
2022/04/15時点で、主要なデータの移管まで完了。新たに追加されたものは、追って対応する。

/edu/entry/bk_campaign     …　仮でリダイレクト設定済（新簿記LPはキャリアになるので）
/edu/entry/bookkeeping     …　仮でリダイレクト設定済（新簿記LPはキャリアになるので）
/edu/entry/coupon          …　ログイン調整済
/edu/entry/internship　    …　リダイレクト済
/edu/entry/kusuri          …　ログイン調整済、一部リダイレクト設定済
/edu/entry/kusuri_inquiry  …　ログイン調整済
/edu/entry/pa_course       …　ログイン調整済
/edu/entry/reader_mt       …　リダイレクト済

/edu/entry/seminar2        …　リダイレクト予定（URL決まり次第）
/edu/entry/signup          …　調整完了

(1)各login.phpの大きな変更としては、以下の部分。

/* JCAuth.phpにて　fetchSessionId_openSSL()と>setSessionDB_openSSL()　を作成 */

//$sessionData = $myJCAuth->fetchSessionId();
  $sessionData = $myJCAuth->fetchSessionId_openSSL();

//$flgSessionDB = $myJCAuth->setSessionDB($api_auth, $encodeId, $sessionData["sid"], $sessionData["iv"]);
  $flgSessionDB = $myJCAuth->setSessionDB_openSSL($api_auth, $encodeId, $sessionData["sid"], $sessionData["iv"]);
// /edu/entry/配下に、common.php　を追加し、以下の内容を追記

//テスト環境フラグ
define('TEST_ENV_FLG', true);

if(!TEST_ENV_FLG){
    //ジャスネットサイトアドレス設定
    define('JUSNET_HTTP_URL', $site_info->JUSNET_SITE_URL);
    define('JUSNET_HTTPS_URL', str_replace("http","https",$site_info->JUSNET_SITE_URL));
    //ジャスネットキャリアサイトアドレス設定
    define('CAREER_HTTP_URL', $site_info->CAREER_SITE_URL);
    define('CAREER_HTTPS_URL', str_replace("http","https",$site_info->CAREER_SITE_URL));
    //ジャスネットスタッフサイトアドレス設定
    define('STAFF_HTTP_URL', $site_info->STAFF_SITE_URL);
    define('STAFF_HTTPS_URL', str_replace("http","https",$site_info->STAFF_SITE_URL));
    //ジャスネットスタッフサイトアドレス設定
    define('EDU_HTTP_URL', $site_info->EDU_SITE_URL);
    define('EDU_HTTPS_URL', str_replace("http","https",$site_info->EDU_SITE_URL));
} else {
    //ジャスネットサイトアドレス設定
    define('JUSNET_HTTP_URL', 'http://awswww.jusnet.co.jp/');
    define('JUSNET_HTTPS_URL', 'https://awswww.jusnet.co.jp/');
    //ジャスネットキャリアサイトアドレス設定
    define('CAREER_HTTP_URL', 'http://awscareer.jusnet.co.jp/');
    define('CAREER_HTTPS_URL', 'https://awscareer.jusnet.co.jp/');
    //ジャスネットスタッフサイトアドレス設定
    define('STAFF_HTTP_URL', 'http://awsstaff.jusnet.co.jp/');
    define('STAFF_HTTPS_URL', 'https://awsstaff.jusnet.co.jp/');
    //ジャスネットスタッフサイトアドレス設定
    define('EDU_HTTP_URL', 'http://awsedu.jusnet.co.jp/');
    define('EDU_HTTPS_URL', 'https://awsedu.jusnet.co.jp/');
}

(2)ログインの際に使用する　/edu/api/session_set_cookie.php　も以下の形で調整

// session_set_cookie.php
/* 以下の関数を作成して、処理*/
function openssl_decode($id,$iv,$sid,$passkey){
    $parameter = array();
    $parameter['id_dec']  = base64_decode(str_replace(array('_', '-', '.'), array('+', '/', '='), $id));
    $parameter['iv_dec']  = base64_decode(str_replace(array('_', '-', '.'), array('+', '/', '='), $iv));
    $parameter['sid_dec'] = base64_decode(str_replace(array('_', '-', '.'), array('+', '/', '='), $sid));
    $parameter['sid_dec'] = openssl_decrypt($parameter['sid_dec'], 'AES-128-CBC', $passkey, OPENSSL_RAW_DATA, $parameter['iv_dec']);
    return $parameter;
}
//　/edu/api/common.php も調整
/* 以下の内容に修正*/

//ini_set("include_path","D:\Inetpub\jusnetcojp\data\lib");
ini_set("include_path", DATA_DIR_PATH.'lib');

//$include_dir = "D:/Inetpub/jusnetcojp";
$include_dir = "/var/www/html";

### 2022/4/21～22
・データベース用のサーバをAWSにて作成。apache,php（phpMyAdmin）,MySQLの設定完了。
・移管するサイトデータが入っているAWSの data/set_info/report_db_conf.ini　もAWSに構築したdatabaseのプライベートIPに変更して接続。
　→ その際に、AWSのセキュリティグループにMySQLのポートを指定し、移管するサイトデータが入っているAWSサーバのプライベートIPを指定すること。
・本番jusnet_dbのSQLデータを大体移管。

https://35.77.101.123/phpmyadmin/

//注意
・jusnet_db->admin　はSF本番用なので、今はテスト環境の値を設定
・jusnet_db->ad_trackingは容量大きいため、未移管
・jusnet_db->temp_fileも容量大きいため、未移管

//エラー
ユーザー問い合わせフォームでエラー発生。
https://awswww.jusnet.co.jp/contact/index.html

→フォームのphpが改修されたみたいなのでまずは差し替えて様子をみる。
→MySQL側のエラーなのであれば回避方法を検討する。
```
$ httpd -v
Server version: Apache/2.4.52 ()
Server built: Dec 30 2021 21:40:08

$ php -v
PHP 8.0.16 (cli) (built: Mar 1 2022 00:31:45) ( NTS )
Copyright (c) The PHP Group
Zend Engine v4.0.16, Copyright (c) Zend Technologies

$ mysqld --version
/usr/sbin/mysqld Ver 8.0.28 for Linux on x86_64 (MySQL Community Server - GPL)
```

2022/04/25
AWSに作ったMySQLのURL

【本日の対応項目】
（１）新規登録フォーム（signup）でエラー発生。
→$myJCADTracking（JCADTrackingのクラス）でエラー発生だったので、
　jusnet_db->ad_tracking　のデータを本番から100行ほど追加。
→「General error: 1364 Field 'sflogin' doesn't have a default value」　というエラーが出てきたため
　jusnet_db->sf_session の sflogin　という項目のデフォルト値を0に設定。（phpmyadmin側で設定）

（参考記事）
https://qiita.com/seltzer/items/3096f0805440bfa19bff
https://dws2020.livedoor.blog/archives/sql_default_value.html
https://blog.dreamhive.co.jp/yama/12197.html

（２）利用者問い合わせフォームでエラー発生。
→現在の本番環境でphpとtplが変わっていたので、まずは同期。
→「General error: 1364 Field 'other_detail' doesn't have a default value」というエラーだったので、
　jusnet_db->user_inquiry　の　other_detailという項目のデフォルト値を""に設定。（これはthanks.php側で設定）

（3）統合型フォームでエラー
→　/edu/js/フィルダ内のファイルが不足していたので追加。
→　/data/jus_tpl/templates/entry/signup/thanks　の教育系テンプレートにおいて、includeの読み込みファイルのパスが間違っていたので修正。

（４）ログイン系の修正
→「General error: 1364 Field 'Description' doesn't have a default value」というエラーだったので、
　jusnet_db->seminar_entry の Description　という項目のデフォルト値を""に設定。（phpmyadmin側で設定）

（５）DB登録時のcreated_at　の時刻がUTCになっていたのでずれる。
→　php.ini　でTimezoneの設定を"Asia/Tokyo"に設定するが変化なし。
→　amazon linux内の時刻を修正して時刻修正完了。

### Amazon Linux 2 インスタンスのタイムゾーンを変更するには
### システムの現在のタイムゾーン設定を表示します。
[ec2-user ~]$ timedatectl

### 使用可能なタイムゾーンを一覧表示します。
[ec2-user ~]$ timedatectl list-timezones

### 選択したタイムゾーンを設定します。
[ec2-user ~]$ sudo timedatectl set-timezone America/Vancouver
（参考記事）
https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/set-time.html
https://gray-code.com/php/setting-timezone-on-php-ini/

### 2022/04/28
テスト環境用のAWS作成中。

```
$ httpd -v
Server version: Apache/2.4.53 ()
Server built: Apr 12 2022 12:00:44

$ php -v
PHP 8.0.16 (cli) (built: Mar 1 2022 00:31:45) ( NTS )
Copyright (c) The PHP Group
Zend Engine v4.0.16, Copyright (c) Zend Technologies

$ mysqld --version
/usr/sbin/mysqld Ver 8.0.29 for Linux on x86_64 (MySQL Community Server - GPL)
```

(手順)
https://qiita.com/miriwo/items/eb09c065ee9bb7e8fe06
※2022年1月より、MySQLのインストールの際にエラーが出るようになっているので、以下の形で対応。
https://blog.katsubemakito.net/mysql/mysql-update-error-gpg

### 2022/05/02
テスト環境用のデータベースの作成まで完了。

100MB以上のデータ取り込みについては、以下の作業を実施。
http://sys-manual.jusnet.co.jp/Web%E9%96%8B%E7%99%BA/AWS/%E3%83%87%E3%83%BC%E3%82%BF%E7%A7%BB%E8%A1%8C%E3%81%AE%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89#%E5%A4%A7%E5%AE%B9%E9%87%8F%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%A2%E3%83%83%E3%83%97%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88LOAD%20DATA%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%80%82

### 2022/05/06、2022/05/09
テスト環境用のデータベースの検証まで完了。

テスト環境用DB(AWS)

・SQLSTATE[HY000] [2054] Server sent charset unknown to the client. Please, report to the developers
→　原因はMySQL側の文字コード。my.cnfでutf8を指定。
https://tech-it.r-net.info/program/php/243/

・MySQL8から認証方法が変更になっているので、ここでもエラー。
→　mysql_native_passwordに設定を変更すると解決する。

・DBとは別にトップページでエラー発生。xxxxx.class_renewal.phpの391行目でエラー。
MySQLの仕様変更で、GROUP BYしたカラム以外取れなくなっていた。
→ANY_VALUE(Occupation1_1__c)　と設定すると解決する。

・求人検索一覧のエラーは、MySQL側でテーブル名の大文字・小文字を区別しているのが原因のよう。
→lower_case_table_names=1　に設定が必要。
→MySQLを新規インストールする場合は、起動前にmy.cnfを編集し、lower_case_table_names=1を記述し、MySQLを立ち上げる必要あり。
→MySQLをインストール済の場合は、一旦アンインストールした方が良い。

・MySQLのバイナリログの設定
→my.cnfにbinlog_expire_logs_seconds　を記述して再起動すれば設定が反映される。

### 2022/05/10
本番用DBの設定まで完了。（テスト環境と同じく設定）

本番用DB(AWS)

※本番DBについては、ad_trackingやlisting_tracがデータ多いため100行のみ登録し、adminはテスト環境用のデータにしている。

【メモ】
データの登録ができない場合があった。
→net_db->idcounterを回している状態で、一旦削除してデータを再度インサートしたことにより、カウンターの巻き戻しを起こしたため。
　candidate_idが重複した状態になるため登録できなくなる。
例：10回登録した状態でidcounterの値を巻き戻すと、統合型フォームでの登録は10回失敗し、11回目で新規登録ができる。

### 2022/05/11
AWSに作成したデータベース（テスト用と本番用）を松本さんにレビュー。

以下、レビューコメント
(1)MySQLのログ保存期限を長くしたい
→　7日間（604800s）に変更。

(2)AWSのログ設定も確認してほしい
→logrotateの設定を確認

logrotateの設定
```
----------------------------------
etc/logrotate.conf　の設定
----------------------------------
# see "man logrotate" for details
# rotate log files weekly
weekly

# keep 4 weeks worth of backlogs
rotate 4

# create new (empty) log files after rotating old ones
create

# use date as a suffix of the rotated file
dateext

# uncomment this if you want your log files compressed
#compress

# RPM packages drop log rotation information into this directory
include /etc/logrotate.d

# no packages own wtmp and btmp -- we'll rotate them here
/var/log/wtmp {
    monthly
    create 0664 root utmp
        minsize 1M
    rotate 1
}

/var/log/btmp {
    missingok
    monthly
    create 0600 root utmp
    rotate 1
}

# system-specific logs may be also be configured here.

----------------------------------
etc/logrotate.d/bootlog　の設定
----------------------------------
/var/log/boot.log
{
    missingok
    daily
    copytruncate
    rotate 7
}

----------------------------------
etc/logrotate.d/syslog　の設定
----------------------------------

/var/log/cron
/var/log/maillog
/var/log/messages
/var/log/secure
/var/log/spooler
{
    missingok
    sharedscripts
    postrotate
        /bin/kill -HUP `cat /var/run/syslogd.pid 2> /dev/null` 2> /dev/null || true
    endscript
}


----------------------------------
etc/logrotate.d/mysql　の設定
----------------------------------
# The log file name and location can be set in
# /etc/my.cnf by setting the "log-error" option
# in [mysqld]  section as follows:
#
# [mysqld]
# log-error=/var/log/mysqld.log
#
# For the mysqladmin commands below to work, root account
# password is required. Use mysql_config_editor(1) to store
# authentication credentials in the encrypted login path file
# ~/.mylogin.cnf
#
# Example usage:
#
#  mysql_config_editor set --login-path=client --user=root --host=localhost --password
#
# When these actions has been done, un-comment the following to
# enable rotation of mysqld's log error.
#

#/var/log/mysqld.log {
#        create 640 mysql mysql
#        notifempty
#        daily
#        rotate 5
#        missingok
#        compress
----------------------------------

----------------------------------
etc/logrotate.d/httpd　の設定
----------------------------------
/var/log/httpd/*log {
    missingok
    notifempty
    sharedscripts
    delaycompress
    postrotate
        /bin/systemctl reload httpd.service > /dev/null 2>/dev/null || true
    endscript
}

# ls /var/log/
amazon             btmp-20220501          lastlog            secure-20220501
audit              chrony                 maillog            secure-20220508
boot.log           cloud-init.log         maillog-20220501   spooler
boot.log-20220505  cloud-init-output.log  maillog-20220508   spooler-20220501
boot.log-20220506  cron                   messages           spooler-20220508
boot.log-20220507  cron-20220501          messages-20220501  tallylog
boot.log-20220508  cron-20220508          messages-20220508  wtmp
boot.log-20220509  dmesg                  mysqld.log         yum.log
boot.log-20220510  grubby_prune_debug     php-fpm
boot.log-20220511  httpd                  sa
btmp               journal                secure


# ls /var/log/httpd
access_log           error_log           ssl_access_log
access_log-20220501  error_log-20220501  ssl_error_log
access_log-20220508  error_log-20220508  ssl_request_log
```
（3）EC2のログをS3に保管する方法を検討してほしい

(1) VPCにエンドポイントというのを作ってS3を認識させる方法
https://avinton.com/academy/upload-file-from-ec2-to-s3/

(2) Amazon Kinesis Data Firehose を使う方法
https://public-cloud-pci-dss.jp/aws/344/

(3) Fluentdというのを使ってS3に送る　というのもありました。
https://dev.classmethod.jp/articles/fluentd-s3/

(1)は、「エンドポイント作成時に一度通信が遮断される」という記述あるので、不安あり。
(2)は、月数千円かかると思いますが、設定はしやすそう。（https://aws.amazon.com/jp/kinesis/data-firehose/pricing/）
(3)は、理解するのに結構時間、要しそう


### 2022/05/16, 2022/05/17
Fluentdを使ってEC2からS3へのログ保存の実装対応し、テスト環境と本番環境に反映済。

今回の作業内容について以下でマニュアル化。
http://sys-manual.jusnet.co.jp/Web%E9%96%8B%E7%99%BA/AWS/Fluentd%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%9FEC2%E2%86%92S3%E3%81%B8%E3%81%AE%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97

※logrotateについてはあとでマニュアルに補足する予定。

引用 編集 #17
石山 廉 さんが9ヶ月前に更新
20220/05/19
logrotateについて以下に変更。

$ sudo vim /etc/logrotate.conf

Daily
rotate 7
fluentdは、1日の終わりに送るようにしたいため、
td-agentの設定ファイルに以下の変更を加えた。

$ cd /etc/td-agent/td-agent.d/
$ sudo vim ******_log.conf

timekey 1440m


### 2022/05/30
テスト環境用のAWSのdatabaseサーバについて、anacronでいったん設定検討中。
https://www.webolve.com/mainte/server/how-to-rotate-log-files-time-by-time/

AWSに作成したdatabaseサーバについて、本日静的IPアドレスを設定済。
http://sys-manual.jusnet.co.jp/Web%E9%96%8B%E7%99%BA/AWS/%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E8%A8%AD%E5%AE%9A

また、phpmyadminを使ったデータ移管のマニュアル（ドラフト版）も作成済。
http://sys-manual.jusnet.co.jp/Web%E9%96%8B%E7%99%BA/MySQL/%E3%83%87%E3%83%BC%E3%82%BF%E7%A7%BB%E7%AE%A1%E6%89%8B%E9%A0%86

mysqldumpに関しては、現在テスト環境にて検討中。

※/var/backup/mysql-dump　を作成して、
シェルスクリプト化し、s3へのdumpデータのアップロードを検討中。

参考記事
https://leben.mobi/blog/mysql_auto_backup/linux/
https://qiita.com/crimson_21/items/6171a95f8ddb2861e2e6
https://dev.mysql.com/doc/refman/8.0/ja/mysqldump.html
https://avinton.com/academy/upload-file-from-ec2-to-s3/

### 2022/05/31
MySQLのdump処理に関するシェルスクリプトとcrontabの設定を対応。
以下のマニュアルを作成済。
http://sys-manual.jusnet.co.jp/Web%E9%96%8B%E7%99%BA/MySQL/dump%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97

ただしcrontabの設定が上手くいってるか後日確認必要。


### ～2022/07/13
本番環境のウェブサーバを構築。t2.largeで100GB
→テスト環境の/var/www/html　を移行済
→DBの接続先は、いったんテスト用DB。
→wsdlファイルも、テスト用SF。
→バックアップ処理は、スクリプト作成し、crontabに設定。しばらく様子みる必要あり。
→ログバックアップは、fluentdで設定。上手くいってないので要確認。
