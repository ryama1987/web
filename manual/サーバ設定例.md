# 前提


①puttyのkey生成

https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/putty.html
# (1)apache関連
```
# apacheのインストール
sudo yum install httpd

# mod_sslのインストール
sudo yum install mod_ssl
```
### （参考）SSLやVirtualHostの設定
```
## （例）/etc/httpd/conf.d/vhost.conf

<VirtualHost *:80>
  ServerName awswww.jusnet.co.jp
  DocumentRoot "/var/www/html/corporate"
  RewriteEngine On
  RewriteCond %{HTTPS} off
  RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R,L]
</VirtualHost>
```
```
##（例）/etc/httpd/conf.d/ssl.conf　があるので流用して以下のように書き換え

#
# When we also provide SSL we have to listen to the 
# the HTTPS port in addition.
#
Listen 443 https

<VirtualHost *:443>

# General setup for the virtual host, inherited from global configuration
#DocumentRoot "/var/www/html"
ServerName awswww.jusnet.co.jp:443
DocumentRoot "/var/www/html/corporate" （←しっかり指定すること）
<Directory "/var/www/html/corporate" >　（←しっかり指定すること）
  DirectoryIndex index.html index.php index.htm index.shtml
  Options -Indexes +Includes +ExecCGI
  AddType text/html .html .shtml
  AddOutputFilter INCLUDES .html .shtml
</Directory>

# Use separate log files for the SSL virtual host; note that LogLevel
# is not inherited from httpd.conf.
ErrorLog logs/ssl_error_log
TransferLog logs/ssl_access_log
LogLevel warn

#   SSL Engine Switch:
#   Enable/Disable SSL for this virtual host.
SSLEngine on

#   SSL Protocol support:
# List the enable protocol levels with which clients will be able to
# connect.  Disable SSLv2 access by default:
SSLProtocol all -SSLv3

#   SSL Cipher Suite:
#   List the ciphers that the client is permitted to negotiate.
#   See the mod_ssl documentation for a complete list.
SSLCipherSuite HIGH:MEDIUM:!aNULL:!MD5:!SEED:!IDEA

#   Speed-optimized SSL Cipher configuration:
#   If speed is your main concern (on busy HTTPS servers e.g.),
#   you might want to force clients to specific, performance
#   optimized ciphers. In this case, prepend those ciphers
#   to the SSLCipherSuite list, and enable SSLHonorCipherOrder.
#   Caveat: by giving precedence to RC4-SHA and AES128-SHA
#   (as in the example below), most connections will no longer
#   have perfect forward secrecy - if the server's key is
#   compromised, captures of past or future traffic must be
#   considered compromised, too.
#SSLCipherSuite RC4-SHA:AES128-SHA:HIGH:MEDIUM:!aNULL:!MD5
#SSLHonorCipherOrder on 

#   Server Certificate:
# Point SSLCertificateFile at a PEM encoded certificate.  If
# the certificate is encrypted, then you will be prompted for a
# pass phrase.  Note that a kill -HUP will prompt again.  A new
# certificate can be generated using the genkey(1) command.
# SSLCertificateFile /etc/pki/tls/certs/localhost.crt
SSLCertificateFile "/etc/pki/tls/certs/jusnetcojp/202109/jusnetcojp_202109_cert.pem"

#   Server Private Key:
#   If the key is not combined with the certificate, use this
#   directive to point at the key file.  Keep in mind that if
#   you've both a RSA and a DSA private key you can configure
#   both in parallel (to also allow the use of DSA ciphers, etc.)
# SSLCertificateKeyFile /etc/pki/tls/private/localhost.key
SSLCertificateKeyFile "/etc/pki/tls/certs/jusnetcojp/202109/jusnetcojp_202109_key_no_pp.pem"

#   Server Certificate Chain:
#   Point SSLCertificateChainFile at a file containing the
#   concatenation of PEM encoded CA certificates which form the
#   certificate chain for the server certificate. Alternatively
#   the referenced file can be the same as SSLCertificateFile
#   when the CA certificates are directly appended to the server
#   certificate for convinience.
#SSLCertificateChainFile /etc/pki/tls/certs/server-chain.crt

#   Certificate Authority (CA):
#   Set the CA certificate verification path where to find CA
#   certificates for client authentication or alternatively one
#   huge file containing all of them (file must be PEM encoded)
#SSLCACertificateFile /etc/pki/tls/certs/ca-bundle.crt
SSLCACertificateFile "/etc/pki/tls/certs/jusnetcojp/202109/jusnetcojp_202109_inca.pem

#   Client Authentication (Type):
#   Client certificate verification type and depth.  Types are
#   none, optional, require and optional_no_ca.  Depth is a
#   number which specifies how deeply to verify the certificate
#   issuer chain before deciding the certificate is not valid.
#SSLVerifyClient require
#SSLVerifyDepth  10

#   Access Control:
#   With SSLRequire you can do per-directory access control based
#   on arbitrary complex boolean expressions containing server
#   variable checks and other lookup directives.  The syntax is a
#   mixture between C and Perl.  See the mod_ssl documentation
#   for more details.
#<Location />
#SSLRequire (    %{SSL_CIPHER} !~ m/^(EXP|NULL)/ \
#            and %{SSL_CLIENT_S_DN_O} eq "Snake Oil, Ltd." \
#            and %{SSL_CLIENT_S_DN_OU} in {"Staff", "CA", "Dev"} \
#            and %{TIME_WDAY} >= 1 and %{TIME_WDAY} <= 5 \
#            and %{TIME_HOUR} >= 8 and %{TIME_HOUR} <= 20       ) \
#           or %{REMOTE_ADDR} =~ m/^192\.76\.162\.[0-9]+$/
#</Location>

#   SSL Engine Options:
#   Set various options for the SSL engine.
#   o FakeBasicAuth:
#     Translate the client X.509 into a Basic Authorisation.  This means that
#     the standard Auth/DBMAuth methods can be used for access control.  The
#     user name is the `one line' version of the client's X.509 certificate.
#     Note that no password is obtained from the user. Every entry in the user
#     file needs this password: `xxj31ZMTZzkVA'.
#   o ExportCertData:
#     This exports two additional environment variables: SSL_CLIENT_CERT and
#     SSL_SERVER_CERT. These contain the PEM-encoded certificates of the
#     server (always existing) and the client (only existing when client
#     authentication is used). This can be used to import the certificates
#     into CGI scripts.
#   o StdEnvVars:
#     This exports the standard SSL/TLS related `SSL_*' environment variables.
#     Per default this exportation is switched off for performance reasons,
#     because the extraction step is an expensive operation and is usually
#     useless for serving static content. So one usually enables the
#     exportation for CGI and SSI requests only.
#   o StrictRequire:
#     This denies access when "SSLRequireSSL" or "SSLRequire" applied even
#     under a "Satisfy any" situation, i.e. when it applies access is denied
#     and no other module can change it.
#   o OptRenegotiate:
#     This enables optimized SSL connection renegotiation handling when SSL
#     directives are used in per-directory context. 
#SSLOptions +FakeBasicAuth +ExportCertData +StrictRequire
<Files ~ "\.(cgi|shtml|phtml|php3?)$">
    SSLOptions +StdEnvVars
</Files>
<Directory "/var/www/cgi-bin">
    SSLOptions +StdEnvVars
</Directory>

#   SSL Protocol Adjustments:
#   The safe and default but still SSL/TLS standard compliant shutdown
#   approach is that mod_ssl sends the close notify alert but doesn't wait for
#   the close notify alert from client. When you need a different shutdown
#   approach you can use one of the following variables:
#   o ssl-unclean-shutdown:
#     This forces an unclean shutdown when the connection is closed, i.e. no
#     SSL close notify alert is send or allowed to received.  This violates
#     the SSL/TLS standard but is needed for some brain-dead browsers. Use
#     this when you receive I/O errors because of the standard approach where
#     mod_ssl sends the close notify alert.
#   o ssl-accurate-shutdown:
#     This forces an accurate shutdown when the connection is closed, i.e. a
#     SSL close notify alert is send and mod_ssl waits for the close notify
#     alert of the client. This is 100% SSL/TLS standard compliant, but in
#     practice often causes hanging connections with brain-dead browsers. Use
#     this only for browsers where you know that their SSL implementation
#     works correctly. 
#   Notice: Most problems of broken clients are also related to the HTTP
#   keep-alive facility, so you usually additionally want to disable
#   keep-alive for those clients, too. Use variable "nokeepalive" for this.
#   Similarly, one has to force some clients to use HTTP/1.0 to workaround
#   their broken HTTP/1.1 implementation. Use variables "downgrade-1.0" and
#   "force-response-1.0" for this.
BrowserMatch "MSIE [2-5]" \
         nokeepalive ssl-unclean-shutdown \
         downgrade-1.0 force-response-1.0

#   Per-Server Logging:
#   The home of a custom SSL log file. Use this when you want a
#   compact non-error SSL logfile on a virtual host basis.
CustomLog logs/ssl_request_log \
          "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"

</VirtualHost>                                  
```

```
# 書き終わったら再起動
systemctl restart httpd
```

```
※エラーが出る場合は　以下でチェック

①構文エラーが無いか
sudo apachectl configtest

②エラーログの詳細を以下で確認する。
sudo vim /var/log/httpd/error_log

```


# (2)php関連

```
(参考　https://it-ouji.com/2021/10/26/aws-ec2%E3%81%ABphp7-4%E3%82%92%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B/)

# パッケージのアップデート
sudo yum update
 
# インストールできるトピックを確認
sudo amazon-linux-extras
 
# php7.4のトピックのレポジトリの有効化
sudo amazon-linux-extras enable php7.4
 
# メタデータ削除
sudo yum clean metadata
 
# php7.4インストール
sudo amazon-linux-extras install php7.4
 
# インストールの確認
php -v
```
## 追加モジュール
・php-mbstring

・php-soap（※SFへのデータ連携時に使用）
```
# インストールの確認
sudo yum install php-mbstring
sudo yum install php-soap
```

```
# 以下で再起動
systemctl restart php-fpm.service
```

# (3)MySQL関連（AWSへのインストール）

```
# 最新状態
sudo yum update

# 最初から入っているMariaDBを削除
sudo yum remove mariadb-*

# MySQLのリポジトリを追加
# 下記サイトの「ダウンロード」リンクがリポジトリに該当するみたい。
# また、rpmでリポジトリを追加するので、localinstallとなっている。
#（参考）https://dev.mysql.com/downloads/repo/yum/
sudo yum localinstall https://dev.mysql.com/get/mysql80-community-release-el7-6.noarch.rpm

# rpm-gpg-key-mysqlというエラーが出るようになった（2022年1月より）
# 以下の対応が必要
sudo rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2022

# インストール（--enablerepo で一時的に有効という意味みたい）
sudo yum install --enablerepo=mysql80-community mysql-community-server

# インストールされているか確認
yum list installed | grep mysql

---------------
# （この設定は、MySQLで大文字や小文字の区別をつける場合に設定するので省略可）
# （ただし、ここで設定しないと後で変更することは不可なので注意）
# ディレクトリを移動
sudo cd /etc

#念のため設定ファイルをバックアップ
sudo cp my.cnf my.cnf_bk20220506

# エディタを使って以下のファイルを開く
sudo vim my.cnf

# 下記の箇所に追記して上書き保存（:wq）
[mysqld]
lower_case_table_names=1
---------------

# MySqldの起動と起動状態の確認
sudo systemctl start mysqld
sudo systemctl status mysqld.service

# インスタンス立ち上げと同時に起動するよう設定
sudo systemctl enable mysqld
```

次に初期パスワードを確認して、再設定する。

```
#LOGの格納場所を開く
# A temporary password is generated for root@localhost: の箇所に初期パスワードが記載されている。
sudo less /var/log/mysqld.log

#rootと初期パスワードでmysqlにログインする。
#以下のコマンド打った後にパスワードを聞かれる。
mysql -u root -p

#ログインできたが、このままだとテーブルを作成したりできないので、パスワードを再設定する。
#最新バージョンだとパスワードの組み合わせが厳しいので注意。
mysql> ALTER USER 'root'@'localhost' identified BY '大文字、小文字、特殊文字(アスタリスク等)を含む新しいrootユーザのパスワード';

#いったんログアウト
mysql> exit

#ログインができたらOK
mysql -u root -p
```
（参考）

https://qiita.com/miriwo/items/eb09c065ee9bb7e8fe06

https://qiita.com/miriwo/items/c0ba0ff17c329700fc9e

https://blog.katsubemakito.net/mysql/mysql-update-error-gpg

https://dev.mysql.com/doc/mysql-yum-repo-quick-guide/en/

https://hit.hateblo.jp/entry/MYSQL/8.0/INSTALL

# (4)phpMyAdmin関連

```
#一応アップデート確認
sudo yum update

#必要なphpモジュールをあらかじめインストール
sudo yum install php-mbstring php-xml -y

#一旦、php-fpmの再起動をする
sudo systemctl restart php-fpm

#任意のディレクトに移動
cd /var/www/html/任意のディレクトリ

# 移動したディレクトリ（例：/var/www/html/任意のディレクトリ）でファイルを入手
wget https://www.phpmyadmin.net/downloads/phpMyAdmin-latest-all-languages.tar.gz

#phpmyadminというディレクトリを作成し、入手したファイルを展開する
sudo mkdir phpmyadmin && sudo tar -xvzf phpMyAdmin-latest-all-languages.tar.gz -C phpmyadmin --strip-components 1

#tarファイルを削除
rm phpMyAdmin-latest-all-languages.tar.gz
```
（参考）

https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ec2-lamp-amazon-linux-2.html

# (5)Movable Type関連
## 事前準備
### apacheの～.confに以下の設定をする
```
# 指定のディレクトリで　CGI を使えるようにする
<Directory /var/www/html/xxxxxxxxxx>
  Options +ExecCGI
  AddHandler cgi-script .cgi .pl
</Directory>
```
## perlのモジュールを追加する

```
# DB接続
sudo yum install perl-DBI

# DB接続ドライバ
sudo yum install perl-DBD-mysql

# モジュールのインストール例
yum install "perl(Image::Magick)" "perl(Digest::MD5)" "perl(Mozilla::CA)"

# CGIが動くかのチェック
perl mt.cgi
```
（参考）

https://qiita.com/bezeklik/items/f2932649dd670f9b5fef

https://deep-blog.jp/engineer/perl-install_drivermysql-failed-cant-locate-dbd-mysql-pm-in-inc/

# (6)MySQL（phpmyadmin）へSQLデータ取り込み作業関連

### 大容量のデータをアップする場合LOAD DATAを使用する。

（背景）

・100MB以上のデータアップの際、phpmyadmin側のアップロードファイル容量の上限を上げてもアップできなかった。またアップできても、504 gateway time-outになる。

・大量処理する場合、LOAD DATA INFILEした方が確実に取り込める。

・LOAD DATA INFILE　ではなく、LOAD DATA LOCAL INFILE　とする。

・さらにMySQL8.0で、LOAD DATA LOCAL INFILEが禁止され、local-infileをONにしなければならなかった。

```
#　まずはクライアント側の--local_infileを有効にする
# 接続時に「--local_infile=1」を指定し、ログインする。
mysql -u root -p --local_infile=1

# サーバ側の「--local_infile=」の設定確認。
mysql> SELECT @@local_infile;

# サーバ側の「--local_infile=1」を設定。
mysql> SET PERSIST local_infile= 1;

# もう一度サーバ側の「--local_infile=」の設定確認。
mysql> SELECT @@local_infile;

# 設定されていれば、以下のLOAD DATAを使った大量データの挿入は以下のコマンドで行う。
mysql> LOAD DATA LOCAL INFILE '/home/ec2-user/pardot_ac_reg_page_score.csv' INTO TABLE jusnet_db.pardot_ac_reg_page_score FIELDS TERMINATED BY ',' ENCLOSED BY '"' (number,prospectID,URL,parameter,title,domain,category,ViewDate,pv_group,cv_flg);

```
（参考）

https://qiita.com/yes_dog/items/57c1a8c03aff8bb177de

http://bashalog.c-brains.jp/19/04/09-164614.php

https://dev.mysql.com/doc/refman/5.6/ja/load-data.html

http://kumagonjp2.blog.fc2.com/blog-entry-120.html

https://mita2db.hateblo.jp/entry/2020/01/13/163218

https://foxglovetree.wiki.fc2.com/wiki/Study.Mayumi.MySQL_import

### アップするファイルサイズや時間を変える場合。

```
/etc/php.iniで下記3項目を編集します。

#アップロードできるファイルのサイズの最大値
upload_max_filesize = 512M

#POSTすることのできるデータの最大値
post_max_size = 512M

#スクリプトが確保できるメモリの最大値
memory_limit = 512M

#この時、上記の値が以下の関係であることに注意してください。
upload_max_filesize ≦ post_max_size ≦ memory_limit
```
（参考）

https://beyondjapan.com/blog/2016/03/phpmyadmin-504-gateway-time-out/

### MySQLにデータ取り込んだ際に時刻が9時間ずれる
```
#以下のコマンドでphp.iniを開き、date.timezone = Asia/Tokyo　を設定。
sudo vim /etc/php.ini

もし時間が変わらなかった場合は、OSの時間自体を変える。

# Amazon Linux 2 インスタンスのタイムゾーンを変更するには
# システムの現在のタイムゾーン設定を表示します。
[ec2-user ~]$ timedatectl

# 使用可能なタイムゾーンを一覧表示します。
[ec2-user ~]$ timedatectl list-timezones

# 選択したタイムゾーンを設定します。
[ec2-user ~]$ sudo timedatectl set-timezone Asia/tokyo
```
（参考）

https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/set-time.html

https://gray-code.com/php/setting-timezone-on-php-ini/

### データベースに接続する際に以下のエラーが出る
・SQLSTATE[HY000] [2054] Server sent charset unknown to the client. Please, report to the developers

・SQLSTATE[HY000] [2054] The server requested authentication method unknown to the client

```
#　ディレクトリを移動
sudo cd /etc

#　vimで開く
sudo vim my.cnf

# 以下を追記する
[client]
default-character-set=utf8

[mysql]
default-character-set=utf8

[mysqld]
default_authentication_plugin = mysql_native_password
collation-server = utf8_general_ci
character-set-server = utf8
```

（参考）

https://qiita.com/mach3/items/7d8282c83cd57606d158

https://dev.mysql.com/doc/refman/5.6/ja/charset-applications.html

https://nogson2.hatenablog.com/entry/2020/09/26/111341

https://tech-it.r-net.info/program/php/243/

---------------
https://hodalog.com/modify-the-character-encode-of-mysql/

https://blog.janjan.net/2018/11/01/mysql8-request-authentication-method-unknown-to-the-client/



https://www.logw.jp/cloudserver/9329.html
