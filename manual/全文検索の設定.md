# 1.テーブルに対する設定

## 1.1 FULLTEXT INDEXが1つの場合

（注）""の表記は、便宜上。SQL文を投げる際には特に必要なし。

FULL TEXT INDEXを作成する場合
```sql
-- FULLTEXT INDEXの貼り方
ALTER TABLE "テーブル名" ADD FULLTEXT INDEX "インデックス名を指定" ("indexを貼るカラム名") WITH PARSER ngram;
# ex. ALTER TABLE corporate_nums ADD FULLTEXT INDEX ftindex1 (name) WITH PARSER ngram;
```
```sql
-- innodb_ft_aux_tableに全文検索インデックスが貼られているテーブルを指定する
SET GLOBAL innodb_ft_aux_table = 'データベース名/テーブル名';
# ex. SET GLOBAL innodb_ft_aux_table = 'search_api_test/corporate_nums';
```
```sql
(1) 自然言語の検索 (IN NATURAL LANGUAGE MOD) 
SELECT * FROM "テーブル名" WHERE MATCH ("カラム名") AGAINST ('キーワード' IN NATURAL LANGUAGE MODE);
# ex. SELECT * FROM corporate_nums WHERE MATCH (name) AGAINST ('図書館' IN NATURAL LANGUAGE MODE);
```
```sql
(2) ブール検索 (IN BOOLEAN MODE)
SELECT * FROM "テーブル名" WHERE MATCH ("カラム名") AGAINST ('キーワード' IN BOOLEAN MODE);
# ex. SELECT * FROM corporate_nums WHERE MATCH (name) AGAINST ('図書館' IN BOOLEAN MODE);
# ex. SELECT * FROM corporate_nums WHERE MATCH (name) AGAINST ('*図書館*' IN BOOLEAN MODE);
# ex. SELECT * FROM corporate_nums WHERE MATCH (name) AGAINST ('+図書館 +一般財団法人' IN BOOLEAN MODE);
```
```sql
(3) クエリ拡張検索 (WITH QUERY EXPANSION)
SELECT * FROM "テーブル名" WHERE MATCH ("カラム名") AGAINST ('キーワード' IN NATURAL LANGUAGE MODE WITH QUERY EXPANSION);
# ex. SELECT * FROM corporate_nums WHERE MATCH (name) AGAINST ('図書館' IN NATURAL LANGUAGE MODE WITH QUERY EXPANSION);
```

```sql
再構築する場合

-- もし既存のDBのENGINEやcharsetを変えるならば
ALTER TABLE "テーブル名" ENGINE=InnoDB;
ALTER TABLE "テーブル名" DEFAULT CHARSET = utf8;
```
```sql
-- まずOPTIMIZE時に全文検索インデックスを再構築するフラグを立てる
SET GLOBAL innodb_optimize_fulltext_only=ON;
```
```sql
-- 次に全文検索インデックスを再構築する
OPTIMIZE TABLE "テーブル名";
# ex. OPTIMIZE TABLE corporate_nums;
```

## 1.2 FULLTEXT INDEXが複数の場合(2つ以上)
（注）""の表記は、便宜上。SQL文を投げる際には特に必要なし。

FULL TEXT INDEXを作成する場合
```sql
-- FULLTEXT INDEXの貼り方（複数）
CREATE FULLTEXT INDEX "インデックス名を指定" ON "テーブル名" ("カラム名1","カラム名2","カラム名3") WITH PARSER ngram;
# ex. CREATE FULLTEXT INDEX ftindex1 ON corporate_nums (name,prefecture_name,city_name) WITH PARSER ngram;
```
```sql
-- innodb_ft_aux_tableに全文検索インデックスが貼られているテーブルを指定する
SET GLOBAL innodb_ft_aux_table = 'データベース名/テーブル名';
# ex. SET GLOBAL innodb_ft_aux_table = 'search_api_test/corporate_nums';
```
```sql
(1) 自然言語の検索 (IN NATURAL LANGUAGE MOD)※1
SELECT * FROM "テーブル名" WHERE MATCH ("カラム名1","カラム名2","カラム名3") AGAINST ('キーワード' IN NATURAL LANGUAGE MODE);
# ex. SELECT * FROM corporate_nums WHERE MATCH (name,prefecture_name,city_name) AGAINST ('図書館' IN NATURAL LANGUAGE MODE);
```
```sql
(2) ブール検索 (IN BOOLEAN MODE)※1
SELECT * FROM "テーブル名" WHERE MATCH ("カラム名1","カラム名2","カラム名3") AGAINST ('キーワード' IN BOOLEAN MODE);
# ex. SELECT * FROM corporate_nums WHERE MATCH (name,prefecture_name,city_name) AGAINST ('図書館' IN BOOLEAN MODE);
# ex. SELECT * FROM corporate_nums WHERE MATCH (name,prefecture_name,city_name) AGAINST ('*図書館*' IN BOOLEAN MODE);
# ex. SELECT * FROM corporate_nums WHERE MATCH (name,prefecture_name,city_name) AGAINST ('+図書館 +一般財団法人' IN BOOLEAN MODE);
```
```sql
(3) クエリ拡張検索 (WITH QUERY EXPANSION)※1
SELECT * FROM "テーブル名" WHERE MATCH ("カラム名1","カラム名2","カラム名3") AGAINST ('キーワード' IN NATURAL LANGUAGE MODE WITH QUERY EXPANSION);
# ex. SELECT * FROM corporate_nums WHERE MATCH (name,prefecture_name,city_name) AGAINST ('図書館' IN NATURAL LANGUAGE MODE WITH QUERY EXPANSION);
```
```sql
※1
MATCHの部分には検索対象のカラムを指定し、AGAINSTには検索したいキーワードを指定します。
MATCH (col1,col2...) AGAINST (expr [search_modifier])
```
FULLTEXT INDEXで複数カラム指定している場合は、MATCHで全てのカラムを指定しないとエラーになるので注意です。

```sql
再構築する場合

-- もし既存のDBのENGINEやcharsetを変えるならば
ALTER TABLE "テーブル名" ENGINE=InnoDB;
ALTER TABLE "テーブル名" DEFAULT CHARSET = utf8;
```
```sql
-- まずOPTIMIZE時に全文検索インデックスを再構築するフラグを立てる
SET GLOBAL innodb_optimize_fulltext_only=ON;
```
```sql
-- 次に全文検索インデックスを再構築する
OPTIMIZE TABLE "テーブル名";
# ex. OPTIMIZE TABLE corporate_nums;
```

# 2.検証と考察
## 2.1 CASE1
- カラムごとに1つずつFULLTEXT INDEXを作成していく。  
→　これは成功した。
```sql:成功例

ALTER TABLE corporate_nums ADD FULLTEXT INDEX cnumfti1 (name) WITH PARSER ngram;
ALTER TABLE corporate_nums ADD FULLTEXT INDEX cnumfti2 (prefecture_name) WITH PARSER ngram;
ALTER TABLE corporate_nums ADD FULLTEXT INDEX cnumfti3 (city_name) WITH PARSER ngram;
```
- 1つずつ作成したFULLTEXT INDEXを組み合わせるには  
以下のようなSELECT文を投げる 
```sql:成功例

SELECT * FROM corporate_nums WHERE MATCH (city_name) AGAINST ('千代田' IN NATURAL LANGUAGE MODE) AND MATCH (name) AGAINST ('図書館' IN NATURAL LANGUAGE MODE);
```

## CASE2
- 複数カラムを含めたFULLTEXT INDEXを作ろうとすると**エラーが起こる場合がある。**  
→ 具体的には、「#1062 - 'NULL-NULL-NULL' は索引 'corporate_nums.ftindex1' で重複しています。」という内容。NULLの箇所が複数ある場合には、向いていないかも。

```sql:失敗例

CREATE FULLTEXT INDEX ftindex1 ON corporate_nums (name,prefecture_name,city_name) WITH PARSER ngram;
```

```sql:成功例

CREATE FULLTEXT INDEX cardsfti1 ON cards (name,description) WITH PARSER ngram;
```

- 成功した場合は  以下のようなSELECT文を投げる 
```sql:成功例

SELECT * FROM corporate_nums WHERE MATCH (name,description) AGAINST ('ブルーアイズ' IN NATURAL LANGUAGE MODE);
```

# 3.参考記事

### 特に参考にした記事
- [世界一わかりやすい FULLTEXT INDEX の説明と気を付けるべきポイント](https://zenn.dev/hiroakey/articles/9f68ad249af20c)
- [MySQLの全文検索で商品検索を作ってみた](https://tech.smartshopping.co.jp/mysql_fulltextindex)
- [14.2.13.3 FULLTEXT インデックス](https://dev.mysql.com/doc/refman/5.6/ja/innodb-fulltext-index.html)
- [ALTER TABLE でテーブルのカラムを追加・変更・削除する](https://sql55.com/t-sql/t-sql-alter-table-1.php)
- [14.6.4 MyISAM から InnoDB へのテーブルの変換](https://dev.mysql.com/doc/refman/5.6/ja/converting-tables-to-innodb.html)  
- [MySQLの全文検索インデックスを触ってみる](https://t-kuni-tech.com/2020/08/24/mysql%E3%81%AE%E5%85%A8%E6%96%87%E6%A4%9C%E7%B4%A2%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%82%92%E8%A7%A6%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B/)
- [MySQL5.7 InnoDB のN-gram全文検索を検証＆サービス導入した](https://horizoon.jp/post/2018/11/19/mysql_innodb_fts/)


-----
### 参考にした記事
- [InnoDB の全文検索機能におけるキャッシュ利用について](https://blog.s-style.co.jp/2018/09/2504/)
- [15.6.2.4 InnoDB FULLTEXT インデックス](https://dev.mysql.com/doc/refman/8.0/ja/innodb-fulltext-index.html)
- [21.29.22 INFORMATION_SCHEMA INNODB_FT_INDEX_TABLE テーブル](https://dev.mysql.com/doc/refman/5.6/ja/information-schema-innodb-ft-index-table-table.html)
- [12.10.8 ngram 全文パーサー](https://dev.mysql.com/doc/refman/8.0/ja/fulltext-search-ngram.html)
- [MySQL5.7 InnoDB のN-gram全文検索を検証＆サービス導入した](https://horizoon.jp/post/2018/11/19/mysql_innodb_fts/)
- [MySQL InnoDB の全文検索機能をサクッと試してみました](https://techblog.gmo-ap.jp/2020/01/06/mysql-innodb-fulltext-search-tuto/)


### あとで読むやつ
- https://qiita.com/clustfe/items/748aac3c7aa46ea8be86
- https://qiita.com/at_1016/items/33186523cfc20fb58675
